@using BB.BL.Domain.Users
@model BB.BL.Domain.Playlists.Playlist
@{
    ViewBag.Title = "View";
    ViewBag.NoFooter = true;
}

@section escape_padding {
<div id="playlistbanner">
    <div class="content">
        @if (Model.ImageUrl != null)
        {
           <img class="borderround" src="~/Content/img/Playlists/@Model.ImageUrl" style="width: 170px; height: 170px" />
        }
        else
        {
           <img class="borderround" src="~/Content/img/playlistavatar.png" style="width: 170px; height: 170px" />
        }
        <h1>@Model.Name</h1>
        <h2>Share your playlist: @Model.Key</h2>
    </div>
</div>    
}

<div id="playlist-view" style="margin-top: 1em">
    @Html.Partial("PlaylistTable", @Model)
</div>

<div id="nowPlayingRow" style="margin-top: 5em">
    @if (((List<User>)ViewBag.Organisers).Any(p => p.Email == User.Identity.Name))
        {
            if (Model.PlaylistTracks.Count != 0)
            {
                <a class="btn" id="playBtn"><i id="icon" class="material-icons">play_arrow</i> </a>
                <a class="btn disabled" id="nextBtn"><i id="icon" class="material-icons">skip_next</i> </a>
            }
            else
            {
                <a class="btn disabled" id="playBtn"><i id="icon" class="material-icons">play_arrow</i> </a>
            }
        }
        else
        {
            <a class="btn" id="playBtn" style="display: none"><i id="icon" class="material-icons">play_arrow</i> </a>
            <a class="btn disabled" style="display: none" id="nextBtn"><i id="icon" class="material-icons">skip_next</i> </a>
        }
    <a href="#addTrackModal" class="btn btn-right" style="display: inline-block">
        <i class="material-icons">playlist_add</i> add track
    </a>
</div>

<div id="addTrackModal" class="modal" style="margin-top: -150px">
    <div class="modal-content" style="width: 30%; height: 60%; min-width: 340px; overflow: hidden">
        <a href="#close" id="close-modal" title="Close" class="close">X</a>
        <div class="modal-body" style="height: 100%; width: 100%">
            @{
                Html.RenderPartial("AddTrack");
            }
        </div>
    </div>
</div>

<div id="footerSlideContainer">
    <div id="footerSlideContent" style="width: 80%">
        <div id="footertop" style="text-align: center; cursor: pointer" click="clickFooter">
            <i id="footerIcon" class="material-icons">keyboard_arrow_up</i>
        </div>
        <i id="fullscreenbutton" class="material-icons">fullscreen</i>
        <table style="width: 100%; margin-top: -15px">
            <tr>
                <td style="width: 5%">
                    <img src="~/Content/img/default_cover.png" id="thumbnail" class="round" style="height: 75px; width: 75px; margin-top: 1em" />
                </td>
                <td style="width: 95%">
                    <div class="title" style="margin-top: 0.5em">
                        <h1>Now Playing </h1> <span id="nowPlaying"></span>
                    </div>
                    <span id="time"></span>
                    <div id="myProgress" class="progress" style="margin-top: 0.2em">
                        <div id="myBar" class="bar"></div>
                    </div>    
                </td>
            </tr>
            
        </table>
        
    </div>
</div>

<div id="player" style="display: none">
</div>

<div id="fullscreenplayer" style="display: none">
    <div id="darkoverlay">
        <img id="nowPlayingLogo" src="~/Content/img/logo_header_white.png" alt="beatbuddy logo" />
    </div>
    <div id="nowPlayingAlbumArt"></div>
    <span id="nowPlayingArtist">Nothing</span>
    <span id="nowPlayingTitle">Is playing right now</span>
    <div id="nowPlayingProgress">
        <div id="nowPlayingProgressBar"></div>
    </div>
    <i id="fullscreenexitbutton" class="material-icons">fullscreen_exit</i>
</div>

@section Scripts{
    <script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        var chat = $.connection.playlistHub;
        $.connection.hub.start().done(function() {
            chat.server.joinGroup("@Model.Id");
        });
        chat.client.addNewMessageToPage = function() {
            updatePlaylist();
        }
        chat.client.startMusicPlaying = function(data) {
            player.cueVideoById(data.TrackId);
            document.getElementById("nowPlaying").innerHTML = data.Title + ' - ' + data.Artist;
            $(function() {
                setInterval(updateTime, 50);
            });
            openFooter();
            $('#thumbnail').attr("src", data.CoverArtUrl);
            updatePlaylist();
            player.playVideo();
        }
            
        chat.client.pauseMusicPlaying = function() {
            player.pauseVideo();
        }
        chat.client.resumeMusicPlaying = function(data) {
            console.log(data);
            player.playVideo();
        }



        var playing = false;
        var footerOpen = false;
        jQuery(function($) {
            $('#footertop').click(function () {
                if(footerOpen === false) {
                    openFooter();
                } else {
                    closeFooter();
                }
            });
        });

        function clickFooter() {
            if (footerOpen) {
                closeFooter();
            } else {
                closeFooter();
            }
        }

        function openFooter() {
            $('#footerSlideContent').animate({ height: '125px' });
            $(this).css('backgroundPosition', 'bottom left');
            $('#nowPlayingRow').animate({ marginBottom: '9em' }, 500, null);
            footerOpen = true;
            var footerIcon = document.getElementById("footerIcon");
            footerIcon.innerHTML = 'keyboard_arrow_down';
        }

        function closeFooter() {
            $('#footerSlideContent').animate({ height: '20px' });
            $(this).css('backgroundPosition', 'top left');
            $('#nowPlayingRow').animate({ marginBottom: '3em' }, 500, null);
            footerOpen = false;
            var footerIcon = document.getElementById("footerIcon");
            footerIcon.innerHTML = 'keyboard_arrow_up';
        }


        var markup = '<li class="track" data-id="${TrackSource.TrackId}">' +
            '<img class="thumbnail" src="${CoverArtUrl}"/>' +
            '<span class="artist">${Artist}</span>' +
            '<span class="tracktitle">${Title}</span>' +
            '</li>';
        $.template("trackTemplate", markup);

        $.ajaxSetup({
            beforeSend: function() {
                $("#loading").show();
            },
            complete: function() {
                $("#loading").hide();
            }
        });
        $("#loading").hide();

        function fetchQueryResults() {
            $.ajax('@Url.Action("SearchTrack")/?q=' + $('#query').val())
                .done(function(result) {
                    $("#results").empty();
                    $.tmpl("trackTemplate", result).appendTo("#results");
                    $("#results li").on("click", function() {
                        addTrack($(this).attr('data-id'));
                    });
                })
                .fail(function() {
                    alert("error");
                });
        }

        function addTrack(id) {
            $.ajax({
                url: '@Url.Action("AddTrack")',
                method: 'POST',
                data: { playlistId: @ViewBag.PlaylistId, id: id },
                async: false
            }).done(function() {
                window.location.href = @ViewBag.PlaylistId + '#close';
                updatePlaylist();
                var playBtn = document.getElementById('playBtn');
                playBtn.className = 'btn';
                playBtn.addEventListener("click", getNextTrack);
                chat.server.addTrack("@Model.Id");
            }).fail(function() {
            notie.alert(3, 'You cannot add a song that is already in the list or is already played', 2.5);
        });
    }

        function debounce(func, wait, immediate) {
            var timeout;
            return function() {
                var context = this, args = arguments;
                var later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                var callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        };

        var debouncedFetch = debounce(function() {
            fetchQueryResults();
        }, 500);

        $("#query").on('keydown', function() {
            debouncedFetch();
        });

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
        var firstPlay = false;

        function onPlayerReady(event) {
            var playButton = document.getElementById("playBtn");
            if(playButton != null) playButton.addEventListener("click", getNextTrack);
                
            var nextButton = document.getElementById("nextBtn");
            if(nextButton != null) nextButton.addEventListener("click", function() {
                    getNextTrack();
                });
            }

        function assignPlaylistMaster(userData) {
            $.ajax('/Playlist/AssignPlaylistMaster/', {
                type: 'POST',
                async: false,
                data: { id: @ViewBag.PlaylistId, userEmail: userData}
            }).done(function() {
                updatePlaylist();
            }).fail(function() {
                
            });
        }

        function updateTime() {
            var time = document.getElementById("time");
            var currentTime = secondsToTime(player.getCurrentTime());
            var duration = secondsToTime(player.getDuration());
            time.innerHTML = currentTime +' | ' + duration;
            var percentageTime = (player.getCurrentTime() / player.getDuration()) * 100;

            var bar = document.getElementById("myBar");
            bar.style.width = percentageTime + '%';

            var barFullscreen = document.getElementById("nowPlayingProgressBar");
            barFullscreen.style.width = percentageTime + '%';
        }

        function secondsToTime(secs)
        {
            d = Number(secs);
            var h = Math.floor(d / 3600);
            var m = Math.floor(d % 3600 / 60);
            var s = Math.floor(d % 3600 % 60);
            return ((h > 0 ? h + ":" + (m < 10 ? "0" : "") : "") + m + ":" + (s < 10 ? "0" : "") + s);
        }
        var startedPlaying = false;

        function onPlayerStateChange(event) {
            var playButton = document.getElementById("playBtn");
            playButton.removeEventListener("click", getNextTrack);
            var icon = document.getElementById("icon");
            if (event.data === -1) {
                player.playVideo();
            }
            if (event.data === YT.PlayerState.PLAYING) {
                playing = true;
                playButton.addEventListener("click", function() {
                    player.pauseVideo();
                    chat.server.pausePlaying("@Model.Id");
                });
                icon.innerHTML = 'pause';
            }
            if (event.data === YT.PlayerState.PAUSED) {
                icon.innerHTML = 'play_arrow';
                playButton.addEventListener("click", function() {
                    player.playVideo();
                    chat.server.resumePlaying(player.getCurrentTime(),"@Model.Id");
                });
            }

            if (startedPlaying && event.data === YT.PlayerState.ENDED) {
                playing = false;
                getNextTrack();
            }
        }

        function getNextTrack() {
            $.ajax('/Playlist/GetNextTrack/', {
                type: 'GET',
                data: { id: @ViewBag.PlaylistId },
                contentType : "application/json",
                dataType : "json"
            }).done(function(data) {
                if (data!=null) {
                    if (!startedPlaying) startedPlaying = true;
                    player.cueVideoById(data.TrackId);
                    document.getElementById("nowPlaying").innerHTML = data.Title + ' - ' + data.Artist;
                    $(function() {
                        setInterval(updateTime, 50);
                    });
                    var nextButton = document.getElementById("nextBtn");
                    if (nextButton != null) {
                        if (data.nextTracks === 1) {
                            nextButton.className = 'btn disabled';
                        } else {
                            nextButton.className = 'btn';
                        }
                    }
                }
                    openFooter();
                    moveTrackToHistory();

                if (data.CoverArtUrl != null) {
                    $('#thumbnail').attr("src", data.CoverArtUrl);
                    $('#nowPlayingAlbumArt').css('background-image', "url(" + data.CoverArtUrl + ")");
                    $('#fullscreenplayer').css('background-image', "url(" + data.CoverArtUrl + ")");
                } else {
                    $('#thumbnail').attr("src", '@Url.Content("~/Content/img/default_cover.png")');
                    $('#nowPlayingAlbumArt').css('background-image', "url(" + '@Url.Content("~/Content/img/default_cover.png")' + ")");
                    $('#fullscreenplayer').css('background-image', "url(" + '@Url.Content("~/Content/img/default_cover.png")' + ")");
                }

                $('#nowPlayingTitle').html(data.Title);
                $('#nowPlayingArtist').html(data.Artist);
                    $('#thumbnail').attr("src", data.CoverArtUrl);

                    player.playVideo();
                    chat.server.startPlaying(data, "@Model.Id");
            }).fail(function() {
                var playBtn = document.getElementById('playBtn');
                playBtn.className = 'btn disabled';
                var icon = document.getElementById("icon");
                icon.innerHTML = 'play_arrow';
                document.getElementById("nowPlaying").innerHTML = '';
                closeFooter();
                playBtn.addEventListener("click", getNextTrack);
                var time = document.getElementById("time");
                time.innerHTML = '';
            });
        }

        function moveTrackToHistory() {
            $.ajax('/Playlist/MoveTrackToHistory/', {
                type: 'POST',
                data: { id: @ViewBag.PlaylistId },
                async: false
            }).done(function() {
                if (!firstPlay) {
                    assignPlaylistMaster('@User.Identity.Name');
                    firstPlay = true;
                } else {
                    updatePlaylist();
                }
            }).fail(function() {
                var nextButton = document.getElementById("nextBtn");
                nextButton.className = 'btn disabled';
                var playButton = document.getElementById("playBtn");
                playButton.className = 'btn disabled';
                var icon = document.getElementById("icon");
                icon.innerHTML = 'play_arrow';
            });
        }

        function stopVideo() {
            player.stopVideo();
        }

        function updatePlaylist() {
            $('#playlist-view').load('/Playlist/GetPlaylist/',{id: @ViewBag.PlaylistId});
            var rowCount = $('#playlist-tracks tr').length;
            if (rowCount >= 1 && playing) {
                var nextButton = document.getElementById("nextBtn");
                nextButton.className = 'btn';
            }
        }

        var fullscreenEnabled = false;
        function fullscreenToggle() {
            $('#fullscreenplayer').fadeToggle(200);
            fullscreenEnabled = !fullscreenEnabled;
        }

        $('#fullscreenbutton').on('click', function() {
            fullscreenToggle();
        });

        $('#fullscreenexitbutton').on('click', function() {
            fullscreenToggle();
        });

        $(document).keyup(function(e) {
            if (e.which === 27) {
                $('#fullscreenplayer').fadeOut(200);
                fullscreenEnabled = false;
        }
        });

        window.onbeforeunload = function(){
            assignPlaylistMaster(@null);
            
        }
    </script>
}