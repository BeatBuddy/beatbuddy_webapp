@using System.Web.Http
@model BB.BL.Domain.Playlists.Playlist

@{
    ViewBag.Title = "History";
    ViewBag.NoFooter = true;
}

@section escape_padding {
    <div id="playlistbanner">
        <div class="content">
            @if (Model.ImageUrl != null)
            {
                <img class="borderround" src="~/Content/img/Playlists/@Model.ImageUrl" style="width: 170px; height: 170px" />
            }
            else
            {
                <img class="borderround" src="~/Content/img/playlistavatar.png" style="width: 170px; height: 170px" />
            }
            <h1>@Model.Name</h1>
            <h2>History</h2>
        </div>
    </div>
}

<div id="playlist-view" style="margin-top: 1em">
    @Html.Partial("PlaylistTable", @Model)
</div>

<div id="nowPlayingRow" style="margin-top: 1em; margin-bottom: 3em">
    @if (Model.PlaylistTracks.Count != 0)
    {
        <a class="btn" id="playBtn"><i id="icon" class="material-icons">play_arrow</i> </a>
    }
    else
    {
        <a class="btn disabled" id="playBtn"><i id="icon" class="material-icons">play_arrow</i> </a>
    }
    <a class="btn disabled" id="nextBtn"><i id="icon" class="material-icons">skip_next</i> </a>
</div>

<div id="footerSlideContainer">
    <div id="footerSlideContent" style="width: 80%">
        <div id="footertop" style="text-align: center; cursor: pointer" click="clickFooter"><i id="footerIcon" class="material-icons">keyboard_arrow_up</i></div>
        <table style="width: 100%; margin-top: -15px">
            <tr>
                <td style="width: 5%">
                    <img src="~/Content/img/song-note.png" id="thumbnail" class="round" style="height: 75px; width: 75px; margin-top: 1em" />
                </td>
                <td style="width: 95%">
                    <div class="title" style="margin-top: 0.5em">
                        <h1>Now Playing </h1> <span id="nowPlaying"></span>
                    </div>
                    <span id="time"></span>
                    <div id="myProgress" class="progress" style="margin-top: 0.2em">
                        <div id="myBar" class="bar"></div>
                    </div>
                </td>
            </tr>

        </table>

    </div>
</div>
<div id="player" style="display: none">
</div>

@section Scripts{
    <script>
        var footerOpen = false;
        jQuery(function($) {
            
            $('#footertop').click(function () {
                if(footerOpen === false) {
                    openFooter();
                } else {
                    closeFooter();
                }
            });		
        });
        function clickFooter() {
            if (footerOpen) {
                closeFooter();
            }
            else {
                closeFooter();
            }
        }
        function openFooter() {
            $('#footerSlideContent').animate({ height: '125px' });
            $(this).css('backgroundPosition', 'bottom left');
            $('#nowPlayingRow').animate({ marginBottom: '9em' }, 500, null);
            footerOpen = true;
            var footerIcon = document.getElementById("footerIcon");

            footerIcon.innerHTML = 'keyboard_arrow_down';
        }
        function closeFooter() {
            $('#footerSlideContent').animate({ height: '20px' });
            $(this).css('backgroundPosition', 'top left');
            $('#nowPlayingRow').animate({ marginBottom: '3em' }, 500, null);
            footerOpen = false;
            var footerIcon = document.getElementById("footerIcon");
            footerIcon.innerHTML = 'keyboard_arrow_up';
        }
        
        var markup = '<li class="track" data-id="${TrackSource.TrackId}">' +
            '<img class="thumbnail" src="${CoverArtUrl}"/>' +
            '<span class="artist">${Artist}</span>' +
            '<span class="tracktitle">${Title}</span>' +
            '</li>';
        $.template("trackTemplate", markup);

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: 'cdwal5Kw3Fc',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
            //player.setPlayBackQuality('small');
        }

        function onPlayerReady(event) {
            var playButton = document.getElementById("playBtn");
            playButton.addEventListener("click", getNextTrack);
            
            var nextButton = document.getElementById("nextBtn");
            nextButton.addEventListener("click", getNextTrack);
        }

        function updateTime() {
            var time = document.getElementById("time");
            var currentTime = secondsToTime(player.getCurrentTime());
            var duration = secondsToTime(player.getDuration());
            time.innerHTML = currentTime +' | ' + duration;
            var percentageTime = (player.getCurrentTime() / player.getDuration()) * 100;
            var bar = document.getElementById("myBar");
            bar.style.width = percentageTime + '%';
        }
        function secondsToTime(secs)
        {
            d = Number(secs);
            var h = Math.floor(d / 3600);
            var m = Math.floor(d % 3600 / 60);
            var s = Math.floor(d % 3600 % 60);
            return ((h > 0 ? h + ":" + (m < 10 ? "0" : "") : "") + m + ":" + (s < 10 ? "0" : "") + s);    
        }
        function onPlayerStateChange(event) {
            var playButton = document.getElementById("playBtn");
            playButton.removeEventListener("click", getNextTrack);
            var icon = document.getElementById("icon");
            if (event.data == YT.PlayerState.PLAYING) {
                playButton.addEventListener("click", function() {
                    player.pauseVideo();
                });
                icon.innerHTML = 'pause';
            }
            if (event.data == YT.PlayerState.PAUSED) {
                icon.innerHTML = 'play_arrow';
                
                playButton.addEventListener("click", function() {
                    player.playVideo();
                });
            }
            if (event.data == YT.PlayerState.ENDED) {
                getNextTrack();
            }
        }

        var currentTrack = 0;

        function getNextTrack() {
            var currentTrackItem = $('.track').get(currentTrack);

            var videoId = currentTrackItem.getAttribute('data-id');
            var trackTitle = currentTrackItem.getAttribute('data-title');
            var trackArtist = currentTrackItem.getAttribute('data-artist');
            var trackThumbnail = currentTrackItem.getAttribute('data-thumbnail');

            player.loadVideoById(videoId);
            document.getElementById("nowPlaying").innerHTML = trackArtist + ' - ' + trackTitle;
            $(function() {
                setInterval(updateTime, 50);
            });

            var nextButton = document.getElementById("nextBtn");
            if (currentTrack === currentTrackItem.length - 1) {
                nextButton.className = 'btn disabled';
            } else {
                nextButton.className = 'btn';     
            }

            openFooter();

            $('#thumbnail').attr("src", trackThumbnail);
            currentTrack++;
        }
        
        function stopVideo() {
            player.stopVideo();
        }

        function updatePlaylist() {
            $('#playlist-view').load('/api/Playlist/GetHistory/',{id: @ViewContext.RouteData.Values["id"]});
        }

    </script>
}