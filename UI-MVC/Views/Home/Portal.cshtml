@using BB.BL.Domain.Organisations
@using BB.BL.Domain.Playlists
@using BB.UI.Web.MVC.Controllers.Utils
@using BB.UI.Web.MVC.Models

@{
    ViewBag.Title = "Portal";
    int plId = 0;
}

@section PortalPageStyle{
    <link href="@Url.Content("~/Content/Portal.min.css")" rel="stylesheet" type="text/css"/>
    <link href="@Url.Content("~/Content/dropit.css")" rel="stylesheet" type="text/css" />
}


@section escape_padding {
    <div class="loggedin-banner">
        <div class="banner-content">
            <h2>Welcome, @ViewBag.Name</h2>
        </div>
    </div>
}

<div id="myModal" class="modal" style="margin-top: -90px">
    <div class="modal-content" style="width: 620px; height: 530px; overflow: hidden">
        <a href="#close" title="Close" class="close">X</a>
        <div class="modal-body" style="margin-left: 60px; width: 100%">
            @Html.Partial("~/Views/Organisations/Create.cshtml", new OrganisationViewModel())
        </div>
    </div>
</div>
<div id="playlistModal" class="modal" style="margin-top: -90px">
    <div class="modal-content" style="width: 850px; height: 530px; overflow: hidden">
        <a href="#close" title="Close" class="close">X</a>
        <div class="modal-body" style="margin-left: 60px; width: 100%">
            @Html.Partial("~/Views/Playlist/Create.cshtml", new PlaylistViewModel())
        </div>
    </div>
</div>
<div id="editPlaylistModal" class="modal" style="margin-top: -90px">
    <div class="modal-content" style="width: 850px; height: 530px; overflow: hidden">
        <a href="#close" title="Close" class="close">X</a>
        <div class="modal-body" id="editPlaylistModal-body" style="margin-left: 60px; width: 100%">
            
        </div>
    </div>
</div>
<section>
    <div class="title">
        <h1>My Organisations</h1>
        @ViewBag.MyOrganisations.Count
        <a href="#myModal" class="btn btn-right btn-portal" style="font-size: 0.6em">
            <i class="material-icons">playlist_add</i> add organisation
        </a>
    </div>
    <div class="container row">
        @foreach (Organisation organisation in ViewBag.MyOrganisations)
        {
            <a href="@Url.Action("Details", "Organisations", new { id = organisation.Id })">
            <div class="col-md-4 col-xs-12 organisation-wrapper">
                @{
                    var organisationSource = "https://unsplash.com/photos/P8kVtyU32I0/download";
                    if (organisation.BannerUrl != null)
                    {
                        organisationSource = FileHelper.GetImagePath("OrganisationsImgPath", organisation.BannerUrl);
                    }
                }

                <div style="background-image: url(@organisationSource)" class="organisation-banner">&nbsp;</div>

                <h3>@organisation.Name</h3>
                <div>@organisation.Playlists.Count playlists</div>
            </div>
            </a>
         }
        @if (ViewBag.MyOrganisations.Count == 0)
        {
            <p style="padding-left: 15px">You are not a member of any organisation... </p>
        }
    </div>
    <div class="clearfix">&nbsp;</div>
</section>

<section>
    <div class="title">
            <h1>My playlists</h1>
        <div id="playlistCount" style="display: inline">@ViewBag.MyPlaylists.Count</div>
        <a href="#playlistModal" class="btn btn-right btn-portal" style="font-size: 0.6em">
            <i class="material-icons">playlist_add</i> add playlist
        </a>
    </div>
    
    <div class="container row more-margin-top" id="myplaylists">
        @foreach (Playlist playlist in ViewBag.MyPlaylists)
        {
            
                <div class="col-md-4 col-xs-12 organisation-wrapper">
                    @{
                        var playlistSource = "/Content/img/playlistavatar.png";
                        if (playlist.ImageUrl != null)
                        {
                            playlistSource = FileHelper.GetImagePath("PlaylistImgPath", playlist.ImageUrl);
                        }
                    }
                    <a href="@Url.Action("View", "Playlist", new {id = playlist.Id})">
                        <img src="@playlistSource" alt="playlist image" class="playlist-image" />


                        <h3>@playlist.Name</h3>
                    </a>
                        <div>@playlist.PlaylistTracks.ToList().FindAll(p => p.PlayedAt == null).Count tracks in queue</div>
                        <ul class="menu pull-right">
                            <li>
                                <a href="#"><i class="material-icons" style="color: black">settings</i></a>
                                <ul>
                                    <li style="cursor: pointer"><a onclick="updatePlaylist(@playlist.Id)">Edit</a></li>
                                    <li style="cursor: pointer"><a onclick="deletePlaylist(@playlist.Id)">Delete</a></li>
                                </ul>
                            </li>
                        </ul>
                        <div class="clear-playlist">&nbsp;</div>
</div>
        }
        @if (ViewBag.MyPlaylists.Count == 0)
        {
            <p style="padding-left: 15px">You do not have any playlists yet...</p>
        }
    </div>
    
    <div class="clearfix">&nbsp;</div>
</section>

<section>
    <div class="title">
        <h1>Playlists</h1>
        you might like
    </div>

    <div class="container row">
        @foreach (Playlist playlist in ViewBag.RecommendedPlaylists)
        {
            <a href="@Url.Action("View", "Playlist", new {id = playlist.Id})">
                <div class="col-md-4 col-xs-12 organisation-wrapper">
                    @{
                        var playlistSource = "/Content/img/playlistavatar.png";
                        if (playlist.ImageUrl != null)
                        {
                            playlistSource = FileHelper.GetImagePath("PlaylistImgPath", playlist.ImageUrl);
                        }
                    }
                    <img src="@playlistSource" alt="playlist image" class="playlist-image"/>

                    <h3>@playlist.Name</h3>

                    <div>@playlist.PlaylistTracks.ToList().FindAll(p => p.PlayedAt == null).Count tracks in queue</div>
                    <div class="clear-playlist">&nbsp;</div>
                </div>
            </a>
        }
    </div>
    <div class="clearfix">&nbsp;</div>
</section>
@section Scripts{
    <script>
    $(document).ready(function () {
        $('.menu').dropit();
    });

    function deletePlaylist(platlistId) {
        $.ajax({
            url: '@Url.Action("Delete","Playlist")',
            method: 'POST',
            data: { id: platlistId }
        }).done(function () {
            notie.alert(1, 'Playlist successfull deleted', 2.5);
            $("#myplaylists").load(location.href + " #myplaylists");
            $("#playlistCount").load(location.href + " #playlistCount");

        }).fail(function() {
            notie.alert(3, 'Failed to delete playlist', 2.5);
        });
    }
        function updatePlaylist(playlistId) {
            $('#editPlaylistModal-body').load("/Playlist/Edit/" + playlistId);
            window.location.href = '#editPlaylistModal';
        }

        document.getElementById('avatar_click2').onclick = function () {
            document.getElementById('avatarImage2').click();
        };
        document.getElementById("avatarImage2").onchange = function () {
            var filename = document.getElementById("avatarImage2").value;
            var lastIndex = filename.lastIndexOf("\\");
            if (lastIndex >= 0) {
                filename = filename.substring(lastIndex + 1);
            }
            document.getElementById("avatarLabel2").innerText = filename;
        };
    </script>    
}
